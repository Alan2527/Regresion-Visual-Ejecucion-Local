name: Regresi√≥n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N√∫mero de versi√≥n a testear'
        required: true
        default: '0'

permissions:
  contents: write # Necesario para hacer el commit del reporte
  pages: write    
  id-token: write 

jobs:
  run_regression_and_deploy:
    runs-on: self-hosted
    environment:
      name: github-pages
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo (CON TOKEN EXPL√çCITO)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 1. EJECUCI√ìN DEL SCRIPT
      - name: üöÄ Ejecutar Regresi√≥n Visual
        shell: cmd
        run: |
          @echo off
          REM La configuraci√≥n de UTF-8 es CR√çTICA
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          REM Limpiar reportes viejos 
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}

      # 2. Renombrar y Desplegar el Reporte a la Rama 'gh-pages'
      - name: üìù Renombrar a index.html y Commit a gh-pages
        run: |
          $reportDir = "Reportes HTML - TN - DESKTOP - PROD"
          $ErrorActionPreference = "Stop" # Mejorar robustez en PowerShell
          
          # 2.1. Renombrar el HTML a index.html (esencial para Pages)
          $reportFile = Get-ChildItem -Path $reportDir -Filter "Reporte_DOM_Estructural_*.html"
          if ($reportFile) {
              Rename-Item -Path $reportFile.FullName -NewName "index.html"
          } else {
              Write-Host "Error: No se encontr√≥ el archivo de reporte HTML."
              exit 1
          }
          
          # 2.2. Configurar Git para la autor√≠a
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2.3. Crear y cambiar a la rama de despliegue (borrando historial previo)
          git checkout --orphan gh-pages
          
          # 2.4. Limpiar el directorio ra√≠z (borrar c√≥digo fuente) para dejar solo el reporte
          Get-ChildItem -Path . -Exclude ".git", "$reportDir" -Force | Remove-Item -Recurse -Force
          
          # 2.5. Mover contenido del reporte a la ra√≠z
          Copy-Item -Path "$reportDir\*" -Destination . -Recurse -Force
          Remove-Item -Path $reportDir -Recurse -Force
          
          # 2.6. Commit y Push
          git add .
          git commit -m "Deploy: Reporte v${{ github.event.inputs.version_number }} (Run ID ${{ github.run_id }})"
          # Forzar el push a la rama 'gh-pages'
          git push -f origin gh-pages
        shell: powershell
        
      # 3. Notificaci√≥n a Slack (CORRECCI√ìN DE SINTAXIS YAML Y ESTRUCTURA JSON ROBUSTA)
      - name: üîî Notificaci√≥n de Reporte a Slack
        uses: slackapi/slack-github-action@v1.23.0
        if: always() 
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 
        with:
          payload: |
            {
              "text": "*Reporte de Regresi√≥n Visual (Desktop PROD)* - Estado: ${{ job.status == 'success' && '√âxito' || 'Fallo' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":chart_with_upwards_trend: *Ejecuci√≥n de Regresi√≥n (DESKTOP PROD)*\n\n*Versi√≥n Testeada:*\n${{ github.event.inputs.version_number }}\n\n*Estado Final:*\n*${{ job.status == 'success' && '‚úÖ √âxito' || '‚ùå Fall√≥' }}*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL del Reporte:* <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/?v=${{ github.run_id }}| Abrir Reporte :link:>"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Ver Ejecuci√≥n:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Enlace a GitHub>"
                  }
                }
              ]
            }
