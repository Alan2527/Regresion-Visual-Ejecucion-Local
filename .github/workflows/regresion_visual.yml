name: Regresi√≥n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N√∫mero de versi√≥n a testear'
        required: true
        default: '0'

# Permisos necesarios para el despliegue con el m√©todo de Artifacts
permissions:
  contents: read     
  pages: write       
  id-token: write    

jobs:
  # 1. JOB DE EJECUCI√ìN: Corre la regresi√≥n en tu Runner de Windows
  run_regression:
    runs-on: self-hosted 
    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4
          
      - name: üöÄ Ejecutar Regresi√≥n Visual
        shell: cmd
        run: |
          @echo off
          REM La configuraci√≥n de UTF-8 es CR√çTICA
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}
          
      # üõ†Ô∏è IMPORTANTE: Renombrar a index.html y mover el contenido a _site
      - name: üõ†Ô∏è Preparar Archivos para Despliegue
        shell: powershell
        run: |
          $reportDir = "Reportes HTML - TN - DESKTOP - PROD"
          
          $reportFile = Get-ChildItem -Path $reportDir -Filter "Reporte_DOM_Estructural_*.html"
          if ($reportFile) {
              Rename-Item -Path $reportFile.FullName -NewName "index.html" 
          } else {
              Write-Host "Error: No se encontr√≥ el archivo de reporte HTML."
              exit 1
          }
          # Crea la carpeta _site y mueve el contenido dentro (Formato que GitHub Pages espera)
          Move-Item -Path $reportDir -Destination "_site" -Force
      
      - name: ‚¨ÜÔ∏è Subir Artefacto para Transferencia (Desde Windows)
        uses: actions/upload-artifact@v4
        with:
          name: pages-report-artifact 
          path: _site 
          retention-days: 1 

  # 2. JOB DE DESPLIEGUE: Corre en el Runner de GitHub (Ubuntu) y usa la acci√≥n oficial
  deploy_pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} 
    
    runs-on: ubuntu-latest 
    needs: run_regression 

    steps:
      - name: ‚¨áÔ∏è Descargar Reporte (a la carpeta 'temp_artifact')
        uses: actions/download-artifact@v4
        with:
          name: pages-report-artifact
          path: temp_artifact
          
      # üõ†Ô∏è FIX DE RUTA (RESUELVE EL ERROR 'tar: _site: Cannot open')
      - name: "üõ†Ô∏è FIX: Re-estructurar el Artefacto para la Acci√≥n de Pages"
        run: |
          # Limpiar y crear el directorio _site
          rm -rf _site
          mkdir _site
          # Mover el contenido de la subcarpeta que download-artifact cre√≥ a _site
          mv temp_artifact/pages-report-artifact/* _site/
          
        shell: bash

      - name: ‚¨ÜÔ∏è Subir Artefacto para Pages (Formato Oficial)
        uses: actions/upload-pages-artifact@v3 
        with:
          path: _site 
          
      - name: üöÄ Desplegar a GitHub Pages y Esperar URL
        id: deployment
        uses: actions/deploy-pages@v4 
        
      # Paso de registro de URL (Indentation check OK)
      - name: üìù URL del Reporte
        run: |
          echo "‚úÖ Despliegue completado. El reporte est√° disponible en:"
          echo "${{ steps.deployment.outputs.page_url }}"
