name: Regresi√≥n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N√∫mero de versi√≥n a testear'
        required: true
        default: '0'

permissions:
  contents: read     
  pages: write       # Necesario para el despliegue
  id-token: write    # Necesario para la autenticaci√≥n de despliegue

jobs:
  # 1. JOB DE EJECUCI√ìN (Corre en tu Runner de Windows)
  run_regression:
    runs-on: self-hosted 
    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4
          
      # 1.1. EJECUCI√ìN DEL SCRIPT
      - name: üöÄ Ejecutar Regresi√≥n Visual
        shell: cmd
        run: |
          @echo off
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          REM Limpiar reportes viejos (en el runner local)
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}
          
      # 1.2. PREPARACI√ìN DEL ARTEFACTO
      - name: üõ†Ô∏è Preparar Archivos para Despliegue
        shell: powershell
        run: |
          $reportDir = "Reportes HTML - TN - DESKTOP - PROD"
          
          # Renombrar a index.html
          $reportFile = Get-ChildItem -Path $reportDir -Filter "Reporte_DOM_Estructural_*.html"
          if ($reportFile) {
              Rename-Item -Path $reportFile.FullName -NewName "index.html"
          } else {
              Write-Host "Error: No se encontr√≥ el archivo de reporte HTML. Deteniendo."
              exit 1
          }
          # Mover todo el contenido al directorio _site
          Move-Item -Path $reportDir -Destination "_site" -Force
      
      # 1.3. SUBIR EL REPORTE COMO ARTEFACTO EST√ÅNDAR (FIX DE COMPATIBILIDAD)
      - name: ‚¨ÜÔ∏è Subir Artefacto para Transferencia
        uses: actions/upload-artifact@v4 # Usa la acci√≥n gen√©rica, compatible con Windows tar
        with:
          name: pages-report-artifact
          path: _site
          retention-days: 1 # Opcional: define cu√°nto tiempo guardarlo

  # 2. JOB DE DESPLIEGUE (Corre en un Runner de GitHub compatible)
  deploy_pages:
    environment:
      name: github-pages
      # Usa la URL que te dar√° el paso de despliegue
      url: ${{ steps.deployment.outputs.page_url }} 
    
    # Usa un runner alojado en GitHub (Linux/Ubuntu) donde las Actions de Pages funcionan sin problemas
    runs-on: ubuntu-latest 
    needs: run_regression # Espera a que la regresi√≥n y subida del artefacto terminen

    steps:
      # 2.1. DESCARGAR EL ARTEFACTO CREADO EN EL JOB ANTERIOR
      - name: ‚¨áÔ∏è Descargar Reporte (del runner de Windows)
        uses: actions/download-artifact@v4
        with:
          name: pages-report-artifact
          path: . # Descarga el contenido del artefacto a la carpeta actual (ser√° la carpeta _site)

      # 2.2. SUBIR EL ARTEFACTO CON EL FORMATO DE PAGES
      - name: ‚¨ÜÔ∏è Subir Artefacto para Pages (Formato Oficial)
        uses: actions/upload-pages-artifact@v3 # Este paso ahora corre en Ubuntu, compatible con 'tar'
        with:
          path: _site 
          
      # 2.3. DESPLEGAR A PAGES Y ESPERAR CONFIRMACI√ìN (FIX de la URL)
      - name: üöÄ Desplegar a GitHub Pages y Esperar URL
        id: deployment
        uses: actions/deploy-pages@v4 # Espera a que la URL est√© 100% actualizada

      # 2.4. NOTIFICACI√ìN A SLACK (USA LA URL CONFIRMADA)
      - name: üîî Notificaci√≥n a Slack
        uses: slackapi/slack-github-action@v1.23.0
        # Revisa el resultado del job anterior (run_regression)
        if: always() 
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 
        with:
          payload: |
            {
              "text": "*Reporte de Regresi√≥n Visual (Desktop PROD)* - Estado: ${{ needs.run_regression.result == 'success' && '√âxito' || 'Fallo' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":chart_with_upwards_trend: *Ejecuci√≥n de Regresi√≥n (DESKTOP PROD)*\n\n*Versi√≥n Testeada:*\n${{ github.event.inputs.version_number }}\n\n*Estado Final:*\n*${{ needs.run_regression.result == 'success' && '‚úÖ √âxito' || '‚ùå Fall√≥' }}*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL del Reporte:* <${{ steps.deployment.outputs.page_url }}| Abrir Reporte :link:>"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Ver Ejecuci√≥n:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Enlace a GitHub>"
                  }
                }
              ]
            }
