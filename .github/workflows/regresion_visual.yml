name: Ejecutar Regresión Visual y Publicar Reporte

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Número de versión a testear"
        required: true
        default: "1"

jobs:
  build:
    runs-on: self-hosted

    steps:
      # ============================
      # CHECKOUT
      # ============================
      - name: Checkout
        uses: actions/checkout@v4

      # ============================
      # PYTHON
      # ============================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager pillow opencv-python-headless

      # ============================
      # EJECUTAR TU SCRIPT
      # ============================
      - name: Run regression script
        id: run_script
        run: |
          mkdir -p reportes_tn_desktop_prod
          python regre_visual_tn_desk_prod.py ${{ github.event.inputs.version }}

          # mover los reportes generados a la carpeta sin espacios
          mv Reportes*/* reportes_tn_desktop_prod/ || true

          # obtener el archivo generado más reciente
          REPORT_FILE=$(ls -t reportes_tn_desktop_prod | head -n 1)
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      # ============================
      # SUBIR A GITHUB PAGES
      # ============================
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: reportes_tn_desktop_prod

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  notify:
    needs: [build, deploy]
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack message
        run: |
          REPORT_FILE="${{ needs.build.outputs.report_file }}"
          BASE_URL="https://alan2527.github.io/Regresion-Visual-Ejecucion-Local"
          
          # generar URL anti-cache
          TS=$(date +%Y%m%d%H%M%S)
          FINAL_URL="$BASE_URL/$REPORT_FILE?v=$TS"

          echo "Enviando a Slack: $FINAL_URL"

          curl -X POST \
            -H "Content-type: application/json" \
            --data "{\"text\":\":bar_chart: Nuevo reporte de regresión\nVersión: ${GITHUB_REF##*/}\n$FINAL_URL\"}" \
            ${{ secrets.SLACK_WEBHOOK }}
