name:  Regresi贸n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N煤mero de versi贸n a testear'
        required: true
        default: '0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run_regression_and_deploy:
    runs-on: self-hosted
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: 猬锔 Checkout del c贸digo
        uses: actions/checkout@v4
          
      # 1. EJECUCIN DEL SCRIPT
      - name:  Ejecutar Regresi贸n Visual
        shell: cmd
        run: |
          @echo off
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}

      # 2. Renombrar el HTML generado a index.html
      - name:  Renombrar a index.html para Pages
        shell: powershell
        run: |
          cd "Reportes HTML - TN - DESKTOP - PROD"
          Get-ChildItem -Filter "Reporte_DOM_Estructural_*.html" | Rename-Item -NewName "index.html"
          
      # 3. Configuraci贸n del Entorno de Pages
      - name: 锔 Configurar GitHub Pages
        uses: actions/configure-pages@v5

      # 4. Cargar el Reporte para Despliegue
      - name: 猬锔 Cargar Reporte para Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'Reportes HTML - TN - DESKTOP - PROD'

      # 5. Desplegar a GitHub Pages
      - name:  Desplegar a GitHub Pages
        id: deployment # Este ID es crucial para capturar la URL
        uses: actions/deploy-pages@v4

      # 6. Notificaci贸n a Slack con la URL
      - name:  Notificaci贸n de Reporte a Slack
        uses: slackapi/slack-action@v1.26.0
        # Ejecuta siempre, incluso si falla un paso anterior, para notificar el estado
        if: always() 
        with:
          # Usamos el Secreto guardado
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          # El mensaje en formato JSON de Slack (Block Kit)
          payload: |
            {
              "text": ":chart_with_upwards_trend: *Reporte de Regresi贸n Visual DESKTOP PROD*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Reporte de Regresi贸n Visual DESKTOP PROD TN*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Versi贸n Testeada:*\n${{ github.event.inputs.version_number }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Estado del Despliegue:*\n${{ job.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*URL del Reporte:*\n<${{ steps.deployment.outputs.page_url }}|Ver Reporte>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ver Ejecuci贸n:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Enlace a GitHub>"
                    }
                  ]
                }
              ]
            }
