name:  Regresi贸n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N煤mero de versi贸n a testear'
        required: true
        default: '0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run_regression_and_deploy:
    # Usamos self-hosted (Windows) para la ejecuci贸n
    runs-on: self-hosted
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: 猬锔 Checkout del c贸digo
        uses: actions/checkout@v4
          
      # 1. EJECUCIN DEL SCRIPT
      - name:  Ejecutar Regresi贸n Visual
        shell: cmd
        run: |
          @echo off
          REM La configuraci贸n de UTF-8 es CRTICA
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          REM Limpiar reportes viejos 
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}

      # 2. Preparaci贸n, Limpieza y Compresi贸n (USO DE POWERSHELL, NO DE TAR)
      - name:  Crear Artefacto ZIP Limpio (PowerShell)
        id: prepare_artifact
        shell: powershell
        run: |
          $reportDir = "Reportes HTML - TN - DESKTOP - PROD"
          $zipPath = "github-pages.zip" # Nombre requerido para el despliegue
          $tempDir = "pages_temp"
          
          # 1. Renombrar el HTML a index.html (necesario para Pages)
          $reportFile = Get-ChildItem -Path $reportDir -Filter "Reporte_DOM_Estructural_*.html"
          if ($reportFile) {
              Rename-Item -Path $reportFile.FullName -NewName "index.html"
          } else {
              Write-Host "Error: No se encontr贸 el archivo de reporte HTML."
              exit 1
          }
          
          # 2. Crear la carpeta temporal limpia
          if (Test-Path $tempDir) { Remove-Item $tempDir -Recurse -Force }
          New-Item -Path $tempDir -ItemType Directory | Out-Null
          
          # 3. Mover/Copiar los contenidos esenciales a la carpeta temporal
          Get-ChildItem -Path "$reportDir\*" | Move-Item -Destination $tempDir
          
          # 4. Eliminar el directorio original
          Remove-Item $reportDir -Recurse -Force

          # 5. Limpiar ZIP antiguo si existe
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          
          # 6. COMPRESIN MANUAL
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath
          
          # 7. Limpiar la carpeta temporal
          Remove-Item $tempDir -Recurse -Force
          
          # 8. Establecer la ruta del ZIP como la salida
          echo "ZIP_PATH=$zipPath" >> $env:GITHUB_OUTPUT

      # 3. Cargar el ZIP como Artefacto (Usamos la acci贸n GENRICA de subida)
      - name: 猬锔 Cargar Artefacto ZIP (Formato Pages)
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: ${{ steps.prepare_artifact.outputs.ZIP_PATH }}
          retention-days: 1
      
      # 4. Configuraci贸n del Entorno de Pages
      - name: 锔 Configurar GitHub Pages
        uses: actions/configure-pages@v5

      # 5. Desplegar a GitHub Pages (Consume el artefacto subido en el paso 3)
      - name:  Desplegar a GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
