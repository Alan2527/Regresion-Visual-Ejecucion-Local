name: üëÅÔ∏è Regresi√≥n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N√∫mero de versi√≥n a testear'
        required: true
        default: '0'

# Permisos requeridos por las acciones oficiales de GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run_regression_and_deploy:
    runs-on: self-hosted # Ejecuta en tu m√°quina local
    environment:
      name: github-pages # Define el entorno de despliegue
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4
          
      # 1. EJECUCI√ìN DEL SCRIPT (Con correcci√≥n de Encoding)
      - name: üöÄ Ejecutar Regresi√≥n Visual (UTF-8 Fix)
        shell: cmd
        run: |
          @echo off
          REM Forzar UTF-8 en CMD y Python
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          REM Limpiar reportes viejos (necesario si el Runner se reutiliza)
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          REM Ejecuci√≥n del script
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}

      # 2. Renombrar el HTML generado a index.html
      - name: üìù Renombrar a index.html para Pages
        shell: powershell
        run: |
          cd "Reportes HTML - TN - DESKTOP - PROD"
          Get-ChildItem -Filter "Reporte_DOM_Estructural_*.html" | Rename-Item -NewName "index.html"
          
      # 3. Backup (Opcional): Subir como Artifact ZIP
      - name: üì¶ Subir Artefacto (Backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Backup-Reporte-v${{ inputs.version_number }}-${{ github.run_id }}
          path: "Reportes HTML - TN - DESKTOP - PROD"
          
      # 4. FIX CR√çTICO: A√±adir Utilitarios de Git Bash al PATH
      - name: üî® Asegurar Utilitarios Unix (Git Bash) en PATH
        shell: powershell
        run: |
          # Esta ruta contiene 'tar', 'bash' y otras utilidades.
          # Reemplaza el PATH temporal del job para que las acciones lo encuentren.
          $gitBinPath = "C:\Program Files\Git\usr\bin"
          "$gitBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
      # 5. Configuraci√≥n del Entorno de Pages
      - name: ‚öôÔ∏è Configurar GitHub Pages
        uses: actions/configure-pages@v5

      # 6. Cargar el Reporte para Despliegue (Ahora deber√≠a encontrar 'tar')
      - name: ‚¨ÜÔ∏è Cargar Reporte para Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'Reportes HTML - TN - DESKTOP - PROD' # Carpeta con el index.html

      # 7. Desplegar a GitHub Pages
      - name: üåê Desplegar a GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
