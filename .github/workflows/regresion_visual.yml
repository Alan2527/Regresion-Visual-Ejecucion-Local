name: Ejecutar Regresi贸n Visual y Publicar Reporte

on:
  workflow_dispatch:
    inputs:
      version:
        description: "N煤mero de versi贸n a testear"
        required: true
        default: "1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- CLONAR REPO ---
      - name: Checkout
        uses: actions/checkout@v3

      # --- INSTALAR PYTHON ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      # --- INSTALAR DEPENDENCIAS ---
      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager pillow opencv-python-headless

      # --- EJECUTAR TU SCRIPT ---
      - name: Run regression script
        id: run_script
        run: |
          python regre_visual_tn_desk_prod.py ${{ github.event.inputs.version }}

          # TOMAR EL TIMESTAMP PRODUCIDO POR EL SCRIPT
          TS=$(ls "Reportes HTML - TN - DESKTOP - PROD" | grep "Reporte_DOM" | tail -n 1 | sed 's/.*_\([0-9]*_[0-9]*\)\.html/\1/')
          echo "timestamp=$TS" >> $GITHUB_OUTPUT

      # --- PUBLICAR EN GITHUB PAGES ---
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: "Reportes HTML - TN - DESKTOP - PROD"

  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy-pages.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v2

  notify:
    needs: [build, deploy]
    runs-on: ubuntu-latest

    steps:
      - name: Enviar mensaje a Slack
        run: |
          # ARMAR URL FINAL ANTI-CACHE
          BASE_URL="https://alan2527.github.io/Regresion-Visual-Ejecucion-Local"
          HTML_FILE=$(ls "Reportes HTML - TN - DESKTOP - PROD" | grep "Reporte_DOM" | tail -n 1)
          TIMESTAMP="${{ needs.build.outputs.timestamp }}"
          FINAL_URL="$BASE_URL/$HTML_FILE?v=$TIMESTAMP"

          echo "URL final: $FINAL_URL"

          # ENVIAR A SLACK
          curl -X POST \
            -H 'Content-type: application/json' \
            --data "{\"text\":\" *Nuevo reporte de regresi贸n ejecutado*\n Versi贸n: ${GITHUB_REF##*/}\n $FINAL_URL\"}" \
            ${{ secrets.SLACK_WEBHOOK }}
