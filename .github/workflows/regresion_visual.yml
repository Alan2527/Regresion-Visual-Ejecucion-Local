name:  Regresi√≥n Visual - DESKTOP PROD

on:
  workflow_dispatch:
    inputs:
      version_number:
        description: 'N√∫mero de versi√≥n a testear'
        required: true
        default: '0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run_regression_and_deploy:
    runs-on: self-hosted
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ‚¨áÔ∏è Checkout del c√≥digo
        uses: actions/checkout@v4
          
      # 1. EJECUCI√ìN DEL SCRIPT
      - name: üöÄ Ejecutar Regresi√≥n Visual
        shell: cmd
        run: |
          @echo off
          REM La configuraci√≥n de UTF-8 es CR√çTICA
          chcp 65001
          set PYTHONIOENCODING=utf-8
          
          REM Limpiar reportes viejos 
          if exist "Reportes HTML - TN - DESKTOP - PROD" (
            rmdir /s /q "Reportes HTML - TN - DESKTOP - PROD"
          )
          
          py regre_visual_tn_desk_prod.py ${{ inputs.version_number }}

      # 2. Preparaci√≥n y Renombrado del Reporte (PowerShell)
      - name: üìù Preparar Reporte (Renombrar y Comprimir)
        id: prepare_artifact
        shell: powershell
        run: |
          $reportDir = "Reportes HTML - TN - DESKTOP - PROD"
          $zipPath = "github-pages.zip" # Nombre del archivo ZIP a subir
          
          # 1. Navegar y Renombrar
          Set-Location $reportDir
          Get-ChildItem -Filter "Reporte_DOM_Estructural_*.html" | Rename-Item -NewName "index.html"
          Set-Location ..
          
          # 2. Limpiar ZIP antiguo si existe
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          
          # 3. COMPRESI√ìN MANUAL: Crea un ZIP limpio sin metadatos problem√°ticos
          # Usamos Compress-Archive para empaquetar la carpeta de reportes en un ZIP.
          # Pages soporta subir artefactos como ZIP.
          Compress-Archive -Path $reportDir\* -DestinationPath $zipPath
          
          # 4. Establecer la ruta del ZIP como la salida para el siguiente paso de subida
          echo "ZIP_PATH=$zipPath" >> $env:GITHUB_OUTPUT

      # 3. Configuraci√≥n del Entorno de Pages
      - name: ‚öôÔ∏è Configurar GitHub Pages
        uses: actions/configure-pages@v5

      # 4. Cargar el ZIP como Artefacto (Sube el archivo ZIP creado manualmente)
      - name: ‚¨ÜÔ∏è Cargar Artefacto ZIP
        uses: actions/upload-artifact@v4
        with:
          # El nombre 'github-pages' es clave
          name: github-pages
          # El path ahora apunta al ZIP creado en el paso anterior
          path: ${{ steps.prepare_artifact.outputs.ZIP_PATH }}
          retention-days: 1
          
      # 5. Desplegar a GitHub Pages 
      - name: üåê Desplegar a GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # 6. Notificaci√≥n a Slack 
      - name: üîî Notificaci√≥n de Reporte a Slack
        uses: slackapi/slack-github-action@v1.23.0
        if: always() 
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 
        with:
          payload: |
            {
              "text": "*Reporte de Regresi√≥n Visual (Desktop PROD)* - Estado: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":chart_with_upwards_trend: *Ejecuci√≥n de Regresi√≥n (DESKTOP PROD)*"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Versi√≥n Testeada:*\n${{ github.event.inputs.version_number }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Estado Final:*\n*${{ job.status == 'success' && '‚úÖ √âxito' || '‚ùå Fall√≥' }}*"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*URL del Reporte:*\n<${{ steps.deployment.outputs.page_url }}|Ver Reporte>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Ver Ejecuci√≥n:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Enlace a GitHub>"
                    }
                  ]
                }
              ]
            }
